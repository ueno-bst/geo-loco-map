<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyDys3l0fXuc1b39XjRGoHdhP24N3Ovg1iI"></script>
    <script type="text/javascript" charset="utf-8" src="https://map.yahooapis.jp/js/V1/jsapi?appid=dj00aiZpPU51NkFQOFB5N0hZVSZzPWNvbnN1bWVyc2VjcmV0Jng9MDg-"></script>
    <script data-main="GeoLocoMap" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.20/require.js"></script>
    <title>sample</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body style="margin: 0; padding: 0;">
<section style="display: flex; width: 100vw; height: 100vh;">
    <div class="map" style="flex-grow: 1"></div>
    <div style="width: 40vw; padding: 1em; display: flex; flex-direction: column;">
        <fieldset style="margin: 0 0 1em 0;">
            <legend>コントロールの表示</legend>
            <label>
                <input type="checkbox" id="ui" value="1"> コントローラー表示
            </label>
            <label>
                <input type="checkbox" id="info" value="1"> 情報バルーン表示(クリック時)
            </label>

            <table>
                <tr>
                    <th><label for="latitude">Lat:</label></th>
                    <td><input id="latitude" type="number" min="-90.00000000" max="90.0000000" step="0.005"></td>
                </tr>
                <tr>
                    <th><label for="longitude">Lng:</label></th>
                    <td><input id="longitude" type="number" min="-180.00000000" max="180.0000000" step="0.005"></td>
                </tr>
                <tr>
                    <th><label for="zoom">Zoom:</label></th>
                    <td><input id="zoom" type="number" min="1" max="20"></td>
                </tr>
                <tr>
                    <th rowspan="4">Bounds:</th>
                    <td><input id="bound-ne" type="number" readonly></td>
                </tr>
                <tr>
                    <td><input id="bound-nw" type="number" readonly></td>
                </tr>
                <tr>
                    <td><input id="bound-se" type="number" readonly></td>
                </tr>
                <tr>
                    <td><input id="bound-sw" type="number" readonly></td>
                </tr>
            </table>
            <input type="button" id="request" value="APIリクエスト">
            <label><input type="checkbox" id="auto-request" value="1"></label>
        </fieldset>
        <fieldset style="position:relative; flex-grow: 1; padding: 1em;">
            <legend>ビュー内にあるマーカー情報 (<var id="marker-count">0</var> / <var id="marker-total">0</var>)</legend>
            <div id="markers" style="position: absolute; left: .5em; top: 1.5em; bottom:0; right: .5em; box-sizing: border-box; border:0; overflow: auto;"></div>
        </fieldset>
    </div>
</section>

<!--<script type="text/javascript" src="../dist/bundle.js"></script>-->
<script type="module">
	require(['GeoLocoMap'], function (a) {
		var markers = [];
		var map = new a.GeoLocoMap({
			map_type: 'yahoo',
			center: [35.6525164, 139.7366392],
			// center: [35, 135],
			zoom: 15,
			// zoom_min: 1,
			zoom_max: 20,
			show_ui: true,
			show_info: true,
			selector: '.map',
			api: {
				url: 'http://oshigoto-lab.aldev.designserver.space/rest-api/gis/v1/bounds/item',
				// url: '/geo-loco-map/src/response.json',
				user: 'oshigoto-dev',
				password: 'sMlre20Y3CUO1xMxlejq',
				precision: 10,
				type: 'bounds',
				delay: 500,
				auto: true
			},
			onInit: function (e) {
				// console.info("onInit", map.controller, e.controller);
			},
			onMove: function (obj, coordinate) {
				console.info("onMove", obj.controller, coordinate.lat, coordinate.lng);
			},
			onZoom: function (obj, zoom) {
				console.info("onZoom", obj.controller, zoom, obj.getBounds().ne, obj.getBounds().sw);
			},
			onUI: function (obj, f) {
				// console.info("onUI", map.controller, obj.controller, f);
			},
			onChange: function (obj) {
				console.info("onChange", map.controller, obj.controller);
				var
					info = obj.getInfo(),
					ui = obj.getUI(),
					center = obj.getCenter(),
					zoom = obj.getZoom(),
					bound = obj.getBounds();

				$("#latitude").val(center.lat);
				$("#longitude").val(center.lng);

				$("#zoom").val(zoom);

				$("#ui").prop("checked", ui);
				$("#info").prop("checked", info);

				$("#auto-request").prop("checked", map.config.api.auto);

				if (bound) {
					$("#bound-ne").val(bound.ne.lat);
					$("#bound-nw").val(bound.ne.lng);
					$("#bound-se").val(bound.sw.lat);
					$("#bound-sw").val(bound.sw.lng);
				}

				renderMarkers();
			}
		});

		map
            .on("request", function(o, url) {
            	console.info(url.build());
            })
            .on("response", function(o, response) {
            	$("#marker-total").text(response.totalCount || 0);
            })
			.on("marker.disable", function (o, ids) {
				markers = [];
				renderMarkers();
			})
			.on("marker.active", function (o, ids) {
				markers = ids;
				renderMarkers();
			});

		var timer;
		function renderMarkers() {
			clearTimeout(timer);

			timer = setTimeout(function() {
				var
					i,
					data = [];

				if (markers && markers.length > 0) {
					for ( i = 0; i < markers.length; i++) {
						data.push(map.getMarker(markers[i]));
					}
				} else {
					data = map.getViewInMarkers(30);
				}

				var $node = $("<ol>").appendTo($("#markers").empty());

				for ( i = 0; i < data.length; i ++) {
					var datum = data[i];

					$node.append($("<li>").html(datum.id + ":" + datum.label));
				}

				$("#marker-count").text(data.length);
            }, 200);
        }

		$("#request").on("click", function () {
			map.request();
		});

		$("#auto-request").on("click", function () {
			var $node = $(this);
			map.config.api.auto = $node.is(":checked");
		});

		$("#info").on("change", function () {
			map.setInfo($("#info:checked").length > 0);
		});

		$("#ui").on("change", function () {
			map.setUI($("#ui:checked").length > 0);
		});

		var centerTimer;
		$("#latitude, #longitude").on("change input", function () {
			clearTimeout(centerTimer);
			centerTimer = setTimeout(function () {
				map.setCenter($("#latitude").val(), $("#longitude").val());
			}, 100);
		});

		var zoomTimer;
		$("#zoom").on("change input", function () {
			clearTimeout(zoomTimer);
			zoomTimer = setTimeout(function () {
				map.setZoom($("#zoom").val());
			}, 100);
		});

		map.addMarker({
			coordinate: [34.6675858, 133.8958007],
			label: "岡山県のてけとーな場所",
			description: "AAA<strong>A</strong>AA",
			description_format: "text",
		});

		map.addMarker({
			id: "temp",
			label: "花屋敷へそ公園店",
			coordinate: [35.000277, 134.9986654],
			description: "AAA<strong>A</strong>AA",
			description_format: "text",
		});

		map.addMarker({
			id: "temp2",
			label: "花屋敷へそ公園店",
			coordinate: [35, 135],
			description: "AAA<strong>A</strong>AA",
			description_format: "text",
		});

		console.info(map);

		// map.removeMarker("temp");
	});

</script>
</body>

</html>
